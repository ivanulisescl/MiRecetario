<!doctype html>
<html lang="es" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Recetario • Gestiona tus recetas</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="manifest.webmanifest" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { brand: { DEFAULT: '#0ea5e9', dark: '#0369a1' } } } }, darkMode: 'class' };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}</style>
  <script>
    (function(){var t=localStorage.getItem('mirecetario-theme');if(t==='dark')document.documentElement.classList.add('dark');else if(t==='light')document.documentElement.classList.remove('dark');else if(window.matchMedia&&matchMedia('(prefers-color-scheme: dark)').matches)document.documentElement.classList.add('dark');})();
  </script>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">
  <header class="sticky top-0 z-20 bg-white/80 dark:bg-slate-900/70 backdrop-blur border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-5xl mx-auto px-4">
      <div class="py-3 flex items-center justify-center sm:justify-start">
        <a href="#/" class="flex items-center gap-2">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 3l9 8h-3v8h-5v-5H11v5H6v-8H3l9-8z" stroke="currentColor" stroke-width="1.5"/></svg>
          <span class="font-semibold text-lg">Mi Recetario</span>
        </a>
      </div>
      <div class="pb-3 flex flex-wrap items-center gap-2">
        <input type="search" id="searchInput" placeholder="Buscar recetas…" class="flex-1 min-w-0 px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm max-w-[220px] sm:max-w-none" aria-label="Buscar recetas" />
        <button type="button" id="btnDarkMode" class="p-2 rounded-lg bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700 shrink-0" title="Cambiar tema" aria-label="Modo oscuro/claro">
          <svg id="iconSun" class="w-5 h-5 hidden dark:block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
          <svg id="iconMoon" class="w-5 h-5 block dark:hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
        </button>
        <a href="#/" class="hidden px-3 py-2 rounded-lg bg-slate-200 dark:bg-slate-800 text-sm shrink-0">Inicio</a>
        <div class="relative shrink-0" id="operacionesWrap">
          <button type="button" id="btnOperaciones" class="p-2 rounded-lg bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700 shrink-0" aria-expanded="false" aria-haspopup="true" title="Operaciones">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="1"/>
              <circle cx="12" cy="5" r="1"/>
              <circle cx="12" cy="19" r="1"/>
            </svg>
          </button>
          <div id="operacionesMenu" class="hidden absolute right-0 top-full mt-1 py-1 min-w-[180px] rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg z-30">
            <a href="#/nueva" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 rounded-t-lg">Nueva receta</a>
            <button type="button" id="btnImportar" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700" title="Cargar recetas desde recipes.json">Importar</button>
            <button type="button" id="btnExportar" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700" title="Descargar recetas como recipes.json">Exportar</button>
            <button type="button" id="btnResetear" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700" title="Cargar recipes.json desde el servidor">Resetear</button>
            <button type="button" id="btnActualizar" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 rounded-b-lg" title="Forzar actualización">Actualizar</button>
          </div>
        </div>
        <a href="#/plan" class="px-3 py-2 rounded-lg bg-brand text-white hover:bg-brand-dark text-sm font-medium shrink-0">Plan semanal</a>
          <div id="operacionesMenu" class="hidden absolute right-0 top-full mt-1 py-1 min-w-[180px] rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-lg z-30">
            <a href="#/nueva" class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 rounded-t-lg">Nueva receta</a>
            <button type="button" id="btnImportar" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700" title="Cargar recetas desde recipes.json">Importar</button>
            <button type="button" id="btnExportar" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700" title="Descargar recetas como recipes.json">Exportar</button>
            <button type="button" id="btnResetear" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700" title="Cargar recipes.json desde el servidor">Resetear</button>
            <button type="button" id="btnActualizar" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 rounded-b-lg" title="Forzar actualización">Actualizar</button>
          </div>
        </div>
        <input type="file" id="headerImportFile" accept=".json,application/json" class="hidden" />
      </div>
    </div>
  </header>
  <main class="max-w-5xl mx-auto px-4 py-6"><div id="app"></div></main>
  <footer class="border-t border-slate-200 dark:border-slate-800 mt-8"><div class="max-w-5xl mx-auto px-4 py-6 text-sm text-slate-500 dark:text-slate-400">Gestiona tus recetas y llévalas contigo en móvil y PC. <span id="appVersion" class="ml-1 font-medium"></span></div></footer>

  <script type="application/json" id="planning-fallback">{"weekdays":["L","M","X","J","V"],"weekdayLabels":{"L":"Lunes","M":"Martes","X":"Miércoles","J":"Jueves","V":"Viernes"},"weeks":[{"id":"2026-01-10","label":"10 ene","comidas":["Fréjoles","Garbanzos con setas","Ensalada de pasta","Fabes amarilles","Ensalada de pasta"],"cenas":["Salmón con verduras soja","Champiñones y tortilla","Bimi y pollo","Puré rojo y barbada",""]},{"id":"2025-02-17","label":"17 feb","comidas":["Fabes con verdura","Fabes con verdura","Ensalada de garbanzos","Fréjoles con patatas",""],"cenas":["Verduras con salmón","Fritos bacalao y coliflor","Fritos bacalao y ensalada tomate","Ceviche coliflor y queso fresco","Fajita rabo de toro y queso curado"]},{"id":"2025-02-24","label":"24 feb","comidas":["Arroz con verduras","Garbanzos con carne y pollo","Arroz con verduras","Garbanzos con carne y pollo","Salmorejo"],"cenas":["Verduras con salmón","Puré y jamón york","Aguacate, tomate, mozzarella, pistachos y pasas","",""]},{"id":"2025-03-03","label":"3 mar","comidas":["","","Fabes con verdura","Ensalada de pasta","Ensalada de pasta"],"cenas":["","","Gazpacho, jamón york y queso fresco","Barbada",""]},{"id":"2025-03-17","label":"17 mar","comidas":["Garbanzos con bacalao","","Menestra","Garbanzos con bacalao",""],"cenas":["Berenjena al horno y pechuga de pollo","Tomate, aguacate y mozzarella","Champiñones, trigueros y tortilla","Bacalao con verduras salteadas",""]},{"id":"2025-03-24","label":"24 mar","comidas":["Ensalada de lentejas","","Fabes con verdura","Fabes con verdura",""],"cenas":["Verduras salteadas con xarda plancha","Crema calabacín y pollo plancha","Berenjenas rellenas","Crema calabacín y barbada",""]},{"id":"2025-04-07","label":"7 abr","comidas":["Ensalada de lentejas","","Fabes con verdura","",""],"cenas":["Verduras con salmón","Ensalada de tomate, aguacata, perlas, pistachos y pasas","","Barbada",""]},{"id":"2025-05-26","label":"26 may","comidas":["Ensaladilla","Garbanzos con bacalao","La Felguera","",""],"cenas":["Verduras con salmón","Pixín plancha","Ensalada mixta","",""]},{"id":"2025-06-02","label":"2 jun","comidas":["Arroz con potarros","La Felguera","Menestra","Menestra",""],"cenas":["Verduras con salmón","Repollo con jengibre y pollo plancha","Berenjenas rellenas","Bimi pixín",""]},{"id":"2025-10-06","label":"6 oct","comidas":["Lentejas","La Felguera","Menestra","Lentejas","Menestra"],"cenas":["Repollo con jengibre y pollo plancha","Berenjenas rellenas","Salmón con repollo con jengibre","Ensalada?",""]},{"id":"2025-10-20","label":"20 oct","comidas":["Arroz con verduras","Guisantes con jamón","La Felguera y casa Ceci","Fabes con verdura","Guisantes con jamón"],"cenas":["Puré y barbada plancha","Berenjenas rellenas","Ensalada y tortilla","Salmón con verduras soja",""]},{"id":"2025-10-27","label":"27 oct","comidas":["Arroz con verduras","Fabes con verdura","La Felguera y casa Ceci","Fabes roxes / Candás","Fabes roxes / Bea"],"cenas":["Cena cumple","Pescado","Berenjenas rellenas","Ensalada y tortilla",""]},{"id":"2025-11-03","label":"3 nov","comidas":["Arroz con verduras","Garbanzos con setas","La Felguera y casa Ceci","Lentejas","Lentejas"],"cenas":["Tosta aguacata, queso y salmón","Pollo plancha y verduras asadas","Bimi y barbada","Salmón con verduras soja",""]},{"id":"2025-11-10","label":"10 nov","comidas":["Repollo","Fabes amarilles","Fabes amarilles","Garbanzos con setas","Ensalada de pasta"],"cenas":["Verduras con salmón","Puré calabacín y tortilla queso","Ensalada y pollo plancha","Bimi y pixín",""]},{"id":"2025-11-17","label":"17 nov","comidas":["Ensalada de lentejas","Fabes con verdura","La Felguera y casa Ceci","Menestra","Menestra"],"cenas":["Berenjenas rellenas","Coliflor y pescado","Puré y tortilla","Bimi y pescado plancha",""]},{"id":"2025-11-24","label":"24 nov","comidas":["Lentejas","Fabes amarilles","La Felguera y casa Ceci","Fabes con verdura",""],"cenas":["Verduras con salmón","Tripollo","","Bimi y pescado plancha",""]},{"id":"2025-12-08","label":"8 dic","comidas":["Fréjoles","Lentejas","Fréjoles","Fabes amarilles","Lentejas"],"cenas":["Ensalada de bacalao","Bimi y pescado plancha","Puré y tortilla","Lechuga y pescado",""]},{"id":"2025-12-15","label":"15 dic","comidas":["","Fabes con verdura","La Felguera y casa Ceci","Fabes amarilles",""],"cenas":["Verduras con salmón","Puré y pollo","Berenjenas rellenas","Bimi y pescado plancha",""]}]}</script>
  <script>
(function () {
  'use strict';

  const APP_VERSION = '1.10.3';
  const STORAGE_KEY = 'mirecetario-recetas';
  const THEME_KEY = 'mirecetario-theme';
  const PLAN_STORAGE_KEY = 'mirecetario-plan-weeks';
  const PLAN_HIDDEN_KEY = 'mirecetario-plan-hidden';
  const state = {
    recipes: [],
    categories: [],
    searchQuery: '',
  };

  function loadPlanWeeks() {
    try {
      var raw = localStorage.getItem(PLAN_STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) { return []; }
  }

  function savePlanWeeks(weeks) {
    localStorage.setItem(PLAN_STORAGE_KEY, JSON.stringify(weeks));
  }

  function loadHiddenPlanIds() {
    try {
      var raw = localStorage.getItem(PLAN_HIDDEN_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) { return []; }
  }

  function saveHiddenPlanIds(ids) {
    localStorage.setItem(PLAN_HIDDEN_KEY, JSON.stringify(ids));
  }

  function planWeekLabel(isoDate) {
    var d = new Date(isoDate + 'T12:00:00');
    var day = d.getDate();
    var months = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
    return day + ' ' + months[d.getMonth()];
  }

  function getAllPlanMeals() {
    var meals = new Set();
    var customWeeks = loadPlanWeeks();
    customWeeks.forEach(function (w) {
      (w.comidas || []).forEach(function (m) { if (m && m.trim()) meals.add(m.trim()); });
      (w.cenas || []).forEach(function (m) { if (m && m.trim()) meals.add(m.trim()); });
    });
    var fallbackEl = document.getElementById('planning-fallback');
    if (fallbackEl && fallbackEl.textContent) {
      try {
        var fallbackData = JSON.parse(fallbackEl.textContent);
        if (fallbackData && Array.isArray(fallbackData.weeks)) {
          fallbackData.weeks.forEach(function (w) {
            (w.comidas || []).forEach(function (m) { if (m && m.trim()) meals.add(m.trim()); });
            (w.cenas || []).forEach(function (m) { if (m && m.trim()) meals.add(m.trim()); });
          });
        }
      } catch (e) {}
    }
    return Array.from(meals).sort();
  }

  function formatWeekTitle(weekId, weekLabel) {
    var d = null;
    var year = null;
    var idStr = String(weekId || '');
    if (/^\d{4}-\d{2}-\d{2}$/.test(idStr)) {
      d = new Date(idStr + 'T12:00:00');
      year = d.getFullYear();
    } else if (/^\d+-(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)$/i.test(idStr)) {
      var parts = idStr.split('-');
      var day = parseInt(parts[0], 10);
      var monthNames = { ene: 0, feb: 1, mar: 2, abr: 3, may: 4, jun: 5, jul: 6, ago: 7, sep: 8, oct: 9, nov: 10, dic: 11 };
      var month = monthNames[parts[1].toLowerCase()];
      if (month !== undefined) {
        year = new Date().getFullYear();
        d = new Date(year, month, day);
      }
    } else if (weekLabel && /^\d+\s+(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)$/i.test(weekLabel)) {
      var parts = weekLabel.split(' ');
      var day = parseInt(parts[0], 10);
      var monthNames = { ene: 0, feb: 1, mar: 2, abr: 3, may: 4, jun: 5, jul: 6, ago: 7, sep: 8, oct: 9, nov: 10, dic: 11 };
      var month = monthNames[parts[1].toLowerCase()];
      if (month !== undefined) {
        year = new Date().getFullYear();
        d = new Date(year, month, day);
      }
    }
    if (!d || isNaN(d.getTime())) {
      return 'Semana del ' + (weekLabel || weekId || '').replace(/</g, '&lt;');
    }
    var dayNum = d.getDate();
    var monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    var monthName = monthNames[d.getMonth()];
    var yearNum = d.getFullYear();
    return 'Semana del <span class="font-bold text-brand dark:text-brand">' + dayNum + ' de ' + monthName + '</span> de ' + yearNum;
  }

  function formatWeekTitlePlain(weekId, weekLabel) {
    var d = null;
    var year = null;
    var idStr = String(weekId || '');
    if (/^\d{4}-\d{2}-\d{2}$/.test(idStr)) {
      d = new Date(idStr + 'T12:00:00');
      year = d.getFullYear();
    } else if (/^\d+-(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)$/i.test(idStr)) {
      var parts = idStr.split('-');
      var day = parseInt(parts[0], 10);
      var monthNames = { ene: 0, feb: 1, mar: 2, abr: 3, may: 4, jun: 5, jul: 6, ago: 7, sep: 8, oct: 9, nov: 10, dic: 11 };
      var month = monthNames[parts[1].toLowerCase()];
      if (month !== undefined) {
        year = new Date().getFullYear();
        d = new Date(year, month, day);
      }
    } else if (weekLabel && /^\d+\s+(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)$/i.test(weekLabel)) {
      var parts = weekLabel.split(' ');
      var day = parseInt(parts[0], 10);
      var monthNames = { ene: 0, feb: 1, mar: 2, abr: 3, may: 4, jun: 5, jul: 6, ago: 7, sep: 8, oct: 9, nov: 10, dic: 11 };
      var month = monthNames[parts[1].toLowerCase()];
      if (month !== undefined) {
        year = new Date().getFullYear();
        d = new Date(year, month, day);
      }
    }
    if (!d || isNaN(d.getTime())) {
      return 'Semana del ' + (weekLabel || weekId || '');
    }
    var dayNum = d.getDate();
    var monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    var monthName = monthNames[d.getMonth()];
    var yearNum = d.getFullYear();
    return 'Semana del ' + dayNum + ' de ' + monthName + ' de ' + yearNum;
  }

  const app = document.querySelector('#app');

  const placeholder = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="640" height="360"><rect width="100%" height="100%" fill="#e2e8f0"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#334155" font-family="Inter,Arial" font-size="22">Imagen no disponible</text></svg>'
  );

  const CATEGORY_LABELS = {
    'de-cuchara': 'De cuchara', 'pures': 'Puré', 'sopas': 'Sopas', 'ensaladas': 'Ensaladas',
    'guisos': 'Guisos', 'pescados': 'Pescados', 'postres': 'Postres', 'varios': 'Varios', 'salado': 'Salado'
  };

  const CATEGORY_SLUGS = Object.keys(CATEGORY_LABELS);

  function imgOrPlaceholder(src) {
    if (!src || src.trim() === '') return Promise.resolve(placeholder);
    return new Promise(function (resolve) {
      var i = new Image();
      i.onload = function () { resolve(src); };
      i.onerror = function () { resolve(placeholder); };
      i.src = src;
    });
  }

  function loadRecipes() {
    try {
      var raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        state.recipes = JSON.parse(raw);
      } else {
        state.recipes = [];
      }
    } catch (e) {
      state.recipes = [];
    }
    var map = new Map();
    state.recipes.forEach(function (r) {
      var slug = r.category || 'varios';
      if (!map.has(slug)) {
        map.set(slug, {
          slug: slug,
          name: CATEGORY_LABELS[slug] || slug,
          img: 'assets/img/categorias/' + slug + '.jpg'
        });
      }
    });
    state.categories = Array.from(map.values());
    if (state.categories.length === 0) {
      CATEGORY_SLUGS.forEach(function (slug) {
        state.categories.push({
          slug: slug,
          name: CATEGORY_LABELS[slug] || slug,
          img: 'assets/img/categorias/' + slug + '.jpg'
        });
      });
    }
    return state.recipes;
  }

  function saveRecipes() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.recipes));
    loadRecipes();
  }

  function exportRecipes() {
    loadRecipes();
    var json = JSON.stringify(state.recipes, null, 2);
    var blob = new Blob([json], { type: 'application/json' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'recipes.json';
    a.click();
    URL.revokeObjectURL(a.href);
    var customWeeks = loadPlanWeeks();
    var hiddenIds = loadHiddenPlanIds();
    var fallbackEl = document.getElementById('planning-fallback');
    var jsonWeeks = [];
    if (fallbackEl && fallbackEl.textContent) {
      try {
        var fallbackData = JSON.parse(fallbackEl.textContent);
        if (fallbackData && Array.isArray(fallbackData.weeks)) {
          jsonWeeks = fallbackData.weeks.filter(function (w) { return hiddenIds.indexOf(w.id) === -1; });
        }
      } catch (e) {}
    }
    var allWeeks = customWeeks.concat(jsonWeeks);
    var planData = {
      weekdays: ['L', 'M', 'X', 'J', 'V'],
      weekdayLabels: { L: 'Lunes', M: 'Martes', X: 'Miércoles', J: 'Jueves', V: 'Viernes' },
      weeks: allWeeks
    };
    var planJson = JSON.stringify(planData, null, 2);
    var planBlob = new Blob([planJson], { type: 'application/json' });
    setTimeout(function () {
      var planA = document.createElement('a');
      planA.href = URL.createObjectURL(planBlob);
      planA.download = 'planning.json';
      planA.click();
      URL.revokeObjectURL(planA.href);
    }, 300);
  }

  function resetRecipes() {
    if (!confirm('¿Restaurar recetas y plan desde el servidor? Se sustituirán las recetas actuales por recipes.json y el plan se restablecerá con planning.json (se quitarán semanas añadidas y ocultas).')) return;
    savePlanWeeks([]);
    saveHiddenPlanIds([]);
    fetch('recipes.json?t=' + Date.now()).then(function (r) { return r.ok ? r.json() : []; }).then(function (data) {
      var arr = Array.isArray(data) ? data : (data.recipes || []);
      state.recipes = arr.length > 0 ? arr : [];
      saveRecipes();
      location.hash = '#/';
      render();
      alert('Recetas y plan restaurados desde el servidor.' + (arr.length > 0 ? ' ' + arr.length + ' recetas.' : ''));
    }).catch(function () {
      alert('No se pudo cargar recipes.json. Comprueba la conexión o la URL.');
    });
  }

  function forceUpdate() {
    if (!confirm('¿Actualizar la aplicación a la última versión? Se recargará la página.')) return;
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function (regs) {
        return Promise.all(regs.map(function (r) { return r.unregister(); }));
      }).then(function () {
        return caches.keys ? caches.keys().then(function (keys) { return Promise.all(keys.map(function (k) { return caches.delete(k); })); }) : Promise.resolve();
      }).then(function () {
        window.location.reload(true);
      });
    } else {
      window.location.reload(true);
    }
  }

  function applyImportedRecipes(text) {
    var data = JSON.parse(text);
    var arr = Array.isArray(data) ? data : (data.recipes || []);
    var map = new Map(state.recipes.map(function (r) { return [String(r.id), r]; }));
    var added = 0, updated = 0;
    arr.forEach(function (r) {
      var id = String(r.id);
      if (map.has(id)) { map.set(id, r); updated++; } else { map.set(id, r); added++; }
    });
    state.recipes = Array.from(map.values());
    return { added: added, updated: updated };
  }

  function nextId() {
    if (state.recipes.length === 0) return 1;
    return Math.max.apply(null, state.recipes.map(function (r) { return Number(r.id) || 0; })) + 1;
  }

  function formatRecipeForShare(rec) {
    var lines = [];
    lines.push(rec.title || 'Sin título');
    lines.push('');
    if (rec.description && rec.description.trim()) {
      lines.push(rec.description.trim());
      lines.push('');
    }
    lines.push('Ingredientes:');
    (rec.ingredients || []).forEach(function (i) { lines.push('- ' + i); });
    lines.push('');
    lines.push('Elaboración:');
    (rec.steps || []).forEach(function (s, idx) { lines.push((idx + 1) + '. ' + s); });
    return lines.join('\n');
  }

  function shareRecipe(id) {
    var rec = state.recipes.find(function (x) { return String(x.id) === String(id); });
    if (!rec) return;
    generateRecipeImage(rec).then(function (blob) {
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = (rec.title || 'receta').replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.png';
      a.click();
      setTimeout(function () {
        URL.revokeObjectURL(url);
        if (navigator.clipboard && navigator.clipboard.write) {
          blob.arrayBuffer().then(function (buffer) {
            return navigator.clipboard.write([
              new ClipboardItem({ 'image/png': new Blob([buffer], { type: 'image/png' }) })
            ]);
          }).then(function () {
            alert('Imagen descargada y copiada al portapapeles.');
          }).catch(function () {
            alert('Imagen descargada. No se pudo copiar al portapapeles.');
          });
        } else {
          alert('Imagen descargada.');
        }
      }, 100);
    }).catch(function (err) {
      console.error('Error generando imagen:', err);
      var text = formatRecipeForShare(rec);
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function () {
          alert('No se pudo generar la imagen. Texto copiado al portapapeles.');
        }).catch(function () { fallbackCopy(text); });
      } else {
        fallbackCopy(text);
      }
    });
  }

  function fallbackCopy(text) {
    var ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand('copy');
      if (window.showShareFeedback) window.showShareFeedback(); else alert('Receta copiada.');
    } catch (e) {
      alert('No se pudo copiar. Copia manualmente:\n\n' + text.slice(0, 200) + '…');
    }
    document.body.removeChild(ta);
  }

  function formatWeekForShare(w, dayLabels) {
    var days = ['L', 'M', 'X', 'J', 'V'];
    var lines = ['Semana del ' + (w.label || w.id || ''), ''];
    (w.comidas || []).forEach(function (c, i) { lines.push((dayLabels[days[i]] || days[i]) + ' - Comida: ' + (c || '-')); });
    (w.cenas || []).forEach(function (c, i) { lines.push((dayLabels[days[i]] || days[i]) + ' - Cena: ' + (c || '-')); });
    return lines.join('\n');
  }

  function wrapText(ctx, text, maxWidth, indent) {
    indent = indent || 0;
    var words = text.split(' ');
    var lines = [];
    var currentLine = '';
    words.forEach(function (word) {
      var testLine = currentLine + (currentLine ? ' ' : '') + word;
      var metrics = ctx.measureText(testLine);
      if (metrics.width > maxWidth - indent && currentLine) {
        lines.push(currentLine);
        currentLine = word;
      } else {
        currentLine = testLine;
      }
    });
    if (currentLine) lines.push(currentLine);
    return lines;
  }

  function generateRecipeImage(rec) {
    return new Promise(function (resolve, reject) {
      try {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        var padding = 40;
        var lineHeight = 28;
        var titleSize = 36;
        var sectionSize = 24;
        var textSize = 18;
        var maxWidth = 800;
        canvas.width = maxWidth;
        var x = padding;
        var y = padding;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#0ea5e9';
        ctx.fillRect(0, 0, canvas.width, 8);
        ctx.fillStyle = '#1e293b';
        ctx.font = 'bold ' + titleSize + 'px Inter, sans-serif';
        var title = rec.title || 'Sin título';
        var titleLines = wrapText(ctx, title, maxWidth - 2 * padding);
        titleLines.forEach(function (line) {
          ctx.fillText(line, x, y);
          y += lineHeight + 8;
        });
        y += 10;
        if (rec.description && rec.description.trim()) {
          ctx.fillStyle = '#64748b';
          ctx.font = textSize + 'px Inter, sans-serif';
          var descLines = wrapText(ctx, rec.description.trim(), maxWidth - 2 * padding);
          descLines.forEach(function (line) {
            ctx.fillText(line, x, y);
            y += lineHeight;
          });
          y += 20;
        }
        if (rec.ingredients && rec.ingredients.length > 0) {
          ctx.fillStyle = '#0ea5e9';
          ctx.font = 'bold ' + sectionSize + 'px Inter, sans-serif';
          ctx.fillText('Ingredientes:', x, y);
          y += lineHeight + 10;
          ctx.fillStyle = '#1e293b';
          ctx.font = textSize + 'px Inter, sans-serif';
          rec.ingredients.forEach(function (ing) {
            var ingLines = wrapText(ctx, '• ' + ing, maxWidth - 2 * padding, x + 20);
            ingLines.forEach(function (line) {
              ctx.fillText(line, x + 20, y);
              y += lineHeight;
            });
          });
          y += 20;
        }
        if (rec.steps && rec.steps.length > 0) {
          ctx.fillStyle = '#0ea5e9';
          ctx.font = 'bold ' + sectionSize + 'px Inter, sans-serif';
          ctx.fillText('Elaboración:', x, y);
          y += lineHeight + 10;
          ctx.fillStyle = '#1e293b';
          ctx.font = textSize + 'px Inter, sans-serif';
          rec.steps.forEach(function (step, idx) {
            var stepText = (idx + 1) + '. ' + step;
            var stepLines = wrapText(ctx, stepText, maxWidth - 2 * padding, x + 20);
            stepLines.forEach(function (line) {
              ctx.fillText(line, x + 20, y);
              y += lineHeight;
            });
            y += 8;
          });
        }
        canvas.height = y + padding;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#0ea5e9';
        ctx.fillRect(0, 0, canvas.width, 8);
        y = padding;
        ctx.fillStyle = '#1e293b';
        ctx.font = 'bold ' + titleSize + 'px Inter, sans-serif';
        titleLines.forEach(function (line) {
          ctx.fillText(line, x, y);
          y += lineHeight + 8;
        });
        y += 10;
        if (rec.description && rec.description.trim()) {
          ctx.fillStyle = '#64748b';
          ctx.font = textSize + 'px Inter, sans-serif';
          var descLines2 = wrapText(ctx, rec.description.trim(), maxWidth - 2 * padding);
          descLines2.forEach(function (line) {
            ctx.fillText(line, x, y);
            y += lineHeight;
          });
          y += 20;
        }
        if (rec.ingredients && rec.ingredients.length > 0) {
          ctx.fillStyle = '#0ea5e9';
          ctx.font = 'bold ' + sectionSize + 'px Inter, sans-serif';
          ctx.fillText('Ingredientes:', x, y);
          y += lineHeight + 10;
          ctx.fillStyle = '#1e293b';
          ctx.font = textSize + 'px Inter, sans-serif';
          rec.ingredients.forEach(function (ing) {
            var ingLines2 = wrapText(ctx, '• ' + ing, maxWidth - 2 * padding, x + 20);
            ingLines2.forEach(function (line) {
              ctx.fillText(line, x + 20, y);
              y += lineHeight;
            });
          });
          y += 20;
        }
        if (rec.steps && rec.steps.length > 0) {
          ctx.fillStyle = '#0ea5e9';
          ctx.font = 'bold ' + sectionSize + 'px Inter, sans-serif';
          ctx.fillText('Elaboración:', x, y);
          y += lineHeight + 10;
          ctx.fillStyle = '#1e293b';
          ctx.font = textSize + 'px Inter, sans-serif';
          rec.steps.forEach(function (step, idx) {
            var stepText2 = (idx + 1) + '. ' + step;
            var stepLines2 = wrapText(ctx, stepText2, maxWidth - 2 * padding, x + 20);
            stepLines2.forEach(function (line) {
              ctx.fillText(line, x + 20, y);
              y += lineHeight;
            });
            y += 8;
          });
        }
        canvas.toBlob(function (blob) {
          if (blob) resolve(blob); else reject(new Error('Error generando imagen'));
        }, 'image/png');
      } catch (e) {
        reject(e);
      }
    });
  }

  function generateWeekImage(w, dayLabels) {
    return new Promise(function (resolve, reject) {
      try {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        var padding = 40;
        var lineHeight = 28;
        var titleSize = 32;
        var daySize = 20;
        var textSize = 18;
        var maxWidth = 900;
        canvas.width = maxWidth;
        var x = padding;
        var y = padding;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#0ea5e9';
        ctx.fillRect(0, 0, canvas.width, 8);
        ctx.fillStyle = '#1e293b';
        ctx.font = 'bold ' + titleSize + 'px Inter, sans-serif';
        var title = formatWeekTitlePlain(w.id, w.label);
        ctx.fillText(title, x, y);
        y += lineHeight + 30;
        var days = ['L', 'M', 'X', 'J', 'V'];
        var dayNames = days.map(function (d) { return dayLabels[d] || d; });
        var colWidth = (maxWidth - 2 * padding) / 3;
        ctx.fillStyle = '#0ea5e9';
        ctx.font = 'bold ' + daySize + 'px Inter, sans-serif';
        ctx.fillText('Día', x, y);
        ctx.fillText('Comida', x + colWidth, y);
        ctx.fillText('Cena', x + colWidth * 2, y);
        y += lineHeight + 15;
        ctx.fillStyle = '#1e293b';
        ctx.font = textSize + 'px Inter, sans-serif';
        days.forEach(function (d, i) {
          var dayName = dayNames[i];
          var comida = (w.comidas && w.comidas[i]) || '-';
          var cena = (w.cenas && w.cenas[i]) || '-';
          var dayY = y;
          ctx.fillStyle = '#64748b';
          ctx.font = 'bold ' + daySize + 'px Inter, sans-serif';
          ctx.fillText(dayName, x, dayY);
          ctx.fillStyle = '#1e293b';
          ctx.font = textSize + 'px Inter, sans-serif';
          var comidaLines = wrapText(ctx, comida, colWidth - 20);
          var cenaLines = wrapText(ctx, cena, colWidth - 20);
          var maxLines = Math.max(comidaLines.length, cenaLines.length, 1);
          comidaLines.forEach(function (line, idx) {
            ctx.fillText(line, x + colWidth, dayY + idx * lineHeight);
          });
          cenaLines.forEach(function (line, idx) {
            ctx.fillText(line, x + colWidth * 2, dayY + idx * lineHeight);
          });
          y += maxLines * lineHeight + 20;
        });
        canvas.height = y + padding;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#0ea5e9';
        ctx.fillRect(0, 0, canvas.width, 8);
        y = padding;
        ctx.fillStyle = '#1e293b';
        ctx.font = 'bold ' + titleSize + 'px Inter, sans-serif';
        ctx.fillText(title, x, y);
        y += lineHeight + 30;
        ctx.fillStyle = '#0ea5e9';
        ctx.font = 'bold ' + daySize + 'px Inter, sans-serif';
        ctx.fillText('Día', x, y);
        ctx.fillText('Comida', x + colWidth, y);
        ctx.fillText('Cena', x + colWidth * 2, y);
        y += lineHeight + 15;
        ctx.fillStyle = '#1e293b';
        ctx.font = textSize + 'px Inter, sans-serif';
        days.forEach(function (d, i) {
          var dayName2 = dayNames[i];
          var comida2 = (w.comidas && w.comidas[i]) || '-';
          var cena2 = (w.cenas && w.cenas[i]) || '-';
          var dayY2 = y;
          ctx.fillStyle = '#64748b';
          ctx.font = 'bold ' + daySize + 'px Inter, sans-serif';
          ctx.fillText(dayName2, x, dayY2);
          ctx.fillStyle = '#1e293b';
          ctx.font = textSize + 'px Inter, sans-serif';
          var comidaLines2 = wrapText(ctx, comida2, colWidth - 20);
          var cenaLines2 = wrapText(ctx, cena2, colWidth - 20);
          var maxLines2 = Math.max(comidaLines2.length, cenaLines2.length, 1);
          comidaLines2.forEach(function (line, idx) {
            ctx.fillText(line, x + colWidth, dayY2 + idx * lineHeight);
          });
          cenaLines2.forEach(function (line, idx) {
            ctx.fillText(line, x + colWidth * 2, dayY2 + idx * lineHeight);
          });
          y += maxLines2 * lineHeight + 20;
        });
        canvas.toBlob(function (blob) {
          if (blob) resolve(blob); else reject(new Error('Error generando imagen'));
        }, 'image/png');
      } catch (e) {
        reject(e);
      }
    });
  }

  function route() {
    var h = location.hash || '#/';
    var p = h.slice(2).split('/').filter(Boolean);
    if (!p.length) return { n: 'home' };
    if (p[0] === 'categoria' && p[1]) return { n: 'cat', slug: p[1] };
    if (p[0] === 'receta' && p[1]) return { n: 'rec', id: p[1] };
    if (p[0] === 'nueva') return { n: 'form', id: null };
    if (p[0] === 'editar' && p[1]) return { n: 'form', id: p[1] };
    if (p[0] === 'plan' && p[1] === 'propuesta') return { n: 'planPropuesta' };
    if (p[0] === 'plan' && p[1] === 'nueva') return { n: 'planNueva' };
    if (p[0] === 'plan' && p[1] === 'editar' && p[2]) return { n: 'planEditar', id: p[2] };
    if (p[0] === 'plan') return { n: 'plan' };
    if (p[0] === 'importar') return { n: 'importar' };
    return { n: '404' };
  }

  async function render() {
    loadRecipes();
    var r = route();
    if (r.n === 'cat') return renderCat(r.slug);
    if (r.n === 'rec') return renderRec(r.id);
    if (r.n === 'form') return renderForm(r.id);
    if (r.n === 'planPropuesta') return renderPlanPropuesta();
    if (r.n === 'planNueva') return renderPlanNueva();
    if (r.n === 'planEditar') return renderPlanEditar(r.id);
    if (r.n === 'plan') return renderPlan();
    if (r.n === 'importar') return renderImportar();
    if (r.n === '404') return render404();
    var q = (state.searchQuery || '').trim();
    if (q.length > 0) return renderSearch(q);
    if (r.n === 'home') return renderHome();
    render404();
  }

  function recipeMatchesQuery(rec, query) {
    var lower = query.toLowerCase();
    var title = (rec.title || '').toLowerCase();
    var desc = (rec.description || '').toLowerCase();
    var ing = (rec.ingredients || []).join(' ').toLowerCase();
    var steps = (rec.steps || []).join(' ').toLowerCase();
    return title.indexOf(lower) !== -1 || desc.indexOf(lower) !== -1 || ing.indexOf(lower) !== -1 || steps.indexOf(lower) !== -1;
  }

  async function renderSearch(query) {
    var list = state.recipes.filter(function (r) { return recipeMatchesQuery(r, query); });
    var cards = await Promise.all(list.map(async function (r) {
      var img = await imgOrPlaceholder(r.image || '');
      var editHref = '#/editar/' + r.id;
      var recetaHref = '#/receta/' + r.id;
      var safeTitle = (r.title || '').replace(/</g, '&lt;').replace(/"/g, '&quot;');
      return '<div class="group relative overflow-hidden rounded-xl border bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:shadow">' +
        '<a href="' + recetaHref + '" class="block aspect-[16/9] relative">' +
        '<img src="' + img + '" alt="' + safeTitle + '" class="w-full h-full object-cover"/>' +
        '<div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>' +
        '<div class="absolute bottom-3 left-3 right-14">' +
        '<h3 class="text-white text-lg font-semibold">' + safeTitle + '</h3>' +
        '<p class="text-white/90 text-sm truncate">' + (r.description || '').replace(/</g, '&lt;') + '</p>' +
        '</div></a>' +
        '<div class="absolute bottom-2 right-2 hidden sm:flex gap-1.5 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity duration-200">' +
        '<button type="button" data-share-id="' + r.id + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-700/90 hover:bg-emerald-600 text-white" title="Compartir">' +
        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg></button>' +
        '<a href="' + editHref + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-700/90 hover:bg-brand text-white" title="Editar" onclick="event.stopPropagation()">' +
        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></a>' +
        '<button type="button" data-delete-id="' + r.id + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-700/90 hover:bg-red-600 text-white" title="Eliminar" onclick="event.preventDefault();event.stopPropagation()">' +
        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>' +
        '</div></div>';
    }));
    var tituloBusqueda = 'Buscar: ' + query.replace(/</g, '&lt;').replace(/"/g, '&quot;');
    app.innerHTML = '<section class="space-y-6">' +
      '<h1 class="text-2xl md:text-3xl font-bold">' + tituloBusqueda + '</h1>' +
      '<p class="text-slate-600 dark:text-slate-400">' + list.length + ' receta' + (list.length !== 1 ? 's' : '') + ' encontrada' + (list.length !== 1 ? 's' : '') + '.</p>' +
      '<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">' + (cards.length ? cards.join('') : '<p class="text-slate-600 dark:text-slate-400 col-span-2">No hay recetas que coincidan.</p>') +
      '</div></section>';
  }

  async function renderHome() {
    var cards = await Promise.all(state.categories.map(async function (c) {
      var img = await imgOrPlaceholder(c.img);
      return '<a href="#/categoria/' + c.slug + '" class="block overflow-hidden rounded-xl border bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:shadow">' +
        '<div class="aspect-[16/9] relative">' +
        '<img src="' + img + '" alt="' + c.name + '" class="w-full h-full object-cover"/>' +
        '<div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>' +
        '<h2 class="absolute bottom-3 left-3 text-white text-xl font-semibold">' + c.name + '</h2>' +
        '</div></a>';
    }));

    app.innerHTML = '<section class="space-y-6">' +
      '<h1 class="text-2xl md:text-3xl font-bold">Categorías</h1>' +
      '<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">' + (cards.length ? cards.join('') : '<p class="text-slate-600 dark:text-slate-400 col-span-2">Aún no hay recetas. Usa los botones del menú para añadir o importar.</p>') +
      '</div></section>';
  }

  async function renderCat(slug) {
    var list = state.recipes.filter(function (r) { return (r.category || 'varios') === slug; });
    var name = state.categories.find(function (c) { return c.slug === slug; })?.name || CATEGORY_LABELS[slug] || slug;

    var cards = await Promise.all(list.map(async function (r) {
      var img = await imgOrPlaceholder(r.image || '');
      var editHref = '#/editar/' + r.id;
      var recetaHref = '#/receta/' + r.id;
      var safeTitle = (r.title || '').replace(/</g, '&lt;').replace(/"/g, '&quot;');
      return '<div class="group relative overflow-hidden rounded-xl border bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:shadow">' +
        '<a href="' + recetaHref + '" class="block aspect-[16/9] relative">' +
        '<img src="' + img + '" alt="' + safeTitle + '" class="w-full h-full object-cover"/>' +
        '<div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>' +
        '<div class="absolute bottom-3 left-3 right-14">' +
        '<h3 class="text-white text-lg font-semibold">' + safeTitle + '</h3>' +
        '<p class="text-white/90 text-sm truncate">' + (r.description || '').replace(/</g, '&lt;') + '</p>' +
        '</div></a>' +
        '<div class="absolute bottom-2 right-2 hidden sm:flex gap-1.5 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity duration-200">' +
        '<button type="button" data-share-id="' + r.id + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-700/90 hover:bg-emerald-600 text-white" title="Compartir">' +
        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg></button>' +
        '<a href="' + editHref + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-700/90 hover:bg-brand text-white" title="Editar" onclick="event.stopPropagation()">' +
        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></a>' +
        '<button type="button" data-delete-id="' + r.id + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-700/90 hover:bg-red-600 text-white" title="Eliminar" onclick="event.preventDefault();event.stopPropagation()">' +
        '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>' +
        '</div></div>';
    }));

    app.innerHTML = '<section class="space-y-6">' +
      '<div class="flex items-center justify-between flex-wrap gap-2">' +
      '<h1 class="text-2xl md:text-3xl font-bold">' + name + '</h1>' +
      '<a href="#/" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-700" title="Volver">' +
      '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></a>' +
      '</div></div>' +
      '<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">' + (cards.length ? cards.join('') : '<p class="text-slate-600 dark:text-slate-400 col-span-2">No hay recetas en esta categoría.</p>') +
      '</div></section>';
  }

  async function renderRec(id) {
    var r = state.recipes.find(function (x) { return String(x.id) === String(id); });
    if (!r) return render404();

    var img = await imgOrPlaceholder(r.image || '');
    var steps = r.steps || [];
    var ing = r.ingredients || [];

    app.innerHTML = '<article class="space-y-6">' +
      '<div class="flex items-center justify-between flex-wrap gap-2">' +
      '<h1 class="text-2xl md:text-3xl font-bold">' + r.title + '</h1>' +
      '<div class="flex gap-2 flex-wrap">' +
      '<a href="#/categoria/' + (r.category || 'varios') + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-700" title="Volver">' +
      '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></a>' +
      '<button type="button" data-share-id="' + r.id + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-emerald-600 hover:text-white" title="Compartir">' +
      '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg></button>' +
      '<a href="#/editar/' + r.id + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-brand hover:text-white" title="Editar">' +
      '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></a>' +
      '<button type="button" id="btnEliminar" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-red-600 hover:text-white" title="Eliminar">' +
      '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>' +
      '</div></div>' +
      '<div class="overflow-hidden rounded-xl border bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700">' +
      '<img src="' + img + '" alt="' + r.title + '" class="w-full aspect-[16/9] object-cover"/>' +
      '<div class="p-4 md:p-6 space-y-4">' +
      '<p class="text-slate-700 dark:text-slate-300">' + (r.description || '') + '</p>' +
      '<div class="grid grid-cols-1 md:grid-cols-3 gap-6">' +
      '<section class="md:col-span-1"><h2 class="text-lg font-semibold mb-2">Ingredientes</h2>' +
      '<ul class="list-disc list-inside space-y-1">' + ing.map(function (i) { return '<li>' + i + '</li>'; }).join('') + '</ul></section>' +
      '<section class="md:col-span-2"><h2 class="text-lg font-semibold mb-2">Elaboración paso a paso</h2>' +
      '<ol class="space-y-3">' + steps.map(function (s, i) {
        return '<li class="flex items-start gap-3 p-3 rounded-lg bg-slate-100 dark:bg-slate-800/60">' +
          '<span class="inline-flex w-8 h-8 rounded-full bg-brand text-white items-center justify-center font-semibold">' + (i + 1) + '</span>' +
          '<div class="flex-1"><p>' + s + '</p></div>' +
          '<label class="ml-auto inline-flex items-center gap-2 text-sm">' +
          '<input type="checkbox" class="rounded" data-step="' + i + '"/> Hecho</label></li>';
      }).join('') + '</ol>' +
      (steps.length ? '<div class="mt-4 flex items-center gap-3"><progress id="progress" max="' + steps.length + '" value="0" class="w-full"></progress><span id="progressText" class="text-sm text-slate-600">0 / ' + steps.length + '</span></div>' : '') +
      '</section></div></div></div></article>';

    var checks = app.querySelectorAll('input[type="checkbox"][data-step]');
    var prog = app.querySelector('#progress');
    var txt = app.querySelector('#progressText');
    if (prog && txt) {
      function updateProgress() {
        var done = Array.from(checks).filter(function (c) { return c.checked; }).length;
        prog.value = done;
        txt.textContent = done + ' / ' + steps.length;
      }
      checks.forEach(function (c) { c.addEventListener('change', updateProgress); });
      updateProgress();
    }

    app.querySelector('#btnEliminar').addEventListener('click', function () {
      if (!confirm("¿Eliminar la receta \"" + r.title + "\"?")) return;
      state.recipes = state.recipes.filter(function (x) { return String(x.id) !== String(id); });
      saveRecipes();
      location.hash = '#/categoria/' + (r.category || 'varios');
      render();
    });
  }

  function renderForm(id) {
    var rec = id ? state.recipes.find(function (x) { return String(x.id) === String(id); }) : null;
    var isNew = !rec;
    var params = new URLSearchParams(location.hash.split('?')[1] || '');
    var catPreset = params.get('categoria') || (rec && rec.category) || 'varios';

    var opts = CATEGORY_SLUGS.map(function (s) {
      return '<option value="' + s + '"' + (catPreset === s ? ' selected' : '') + '>' + (CATEGORY_LABELS[s] || s) + '</option>';
    }).join('');

    app.innerHTML = '<section class="max-w-2xl space-y-6">' +
      '<h1 class="text-2xl font-bold">' + (isNew ? 'Nueva receta' : 'Editar receta') + '</h1>' +
      '<form id="formReceta" class="space-y-4 p-4 rounded-xl border bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700">' +
      '<div><label class="block text-sm font-medium mb-1">Título</label><input type="text" name="title" value="' + (rec ? rec.title.replace(/"/g, '&quot;') : '') + '" required class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800" placeholder="Ej: Lentejas"/></div>' +
      '<div><label class="block text-sm font-medium mb-1">Categoría</label><select name="category" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800">' + opts + '</select></div>' +
      '<div><label class="block text-sm font-medium mb-1">Descripción (opcional)</label><textarea name="description" rows="2" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800" placeholder="Breve descripción">' + (rec ? (rec.description || '').replace(/</g, '&lt;') : '') + '</textarea></div>' +
      '<div><label class="block text-sm font-medium mb-1">URL de imagen (opcional)</label><input type="text" name="image" value="' + (rec && rec.image ? rec.image.replace(/"/g, '&quot;') : '') + '" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800" placeholder="https://... o assets/img/recetas/foto.jpg"/></div>' +
      '<div><label class="block text-sm font-medium mb-1">Ingredientes (uno por línea)</label><textarea name="ingredients" rows="6" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800" placeholder="1 cebolla\n2 dientes de ajo">' + (rec && rec.ingredients ? rec.ingredients.map(function (i) { return i.replace(/</g, '&lt;'); }).join('\n') : '') + '</textarea></div>' +
      '<div><label class="block text-sm font-medium mb-1">Pasos (uno por línea)</label><textarea name="steps" rows="8" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800" placeholder="Paso 1\nPaso 2">' + (rec && rec.steps ? rec.steps.map(function (s) { return s.replace(/</g, '&lt;'); }).join('\n') : '') + '</textarea></div>' +
      '<div class="flex gap-2">' +
      '<button type="submit" class="px-4 py-2 rounded-lg bg-brand text-white hover:bg-brand-dark">' + (isNew ? 'Crear receta' : 'Guardar') + '</button>' +
      '<a href="' + (isNew ? '#/' : '#/receta/' + id) + '" class="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700">Cancelar</a>' +
      '</div></form></section>';

    app.querySelector('#formReceta').addEventListener('submit', function (e) {
      e.preventDefault();
      var form = e.target;
      var title = (form.title.value || '').trim();
      var category = (form.category.value || 'varios').trim();
      var description = (form.description.value || '').trim();
      var image = (form.image.value || '').trim();
      var ingredients = (form.ingredients.value || '').split('\n').map(function (s) { return s.trim(); }).filter(Boolean);
      var steps = (form.steps.value || '').split('\n').map(function (s) { return s.trim(); }).filter(Boolean);

      if (isNew) {
        state.recipes.push({
          id: nextId(),
          category: category,
          title: title,
          description: description,
          image: image,
          ingredients: ingredients,
          steps: steps
        });
        saveRecipes();
        location.hash = '#/receta/' + state.recipes[state.recipes.length - 1].id;
      } else {
        var idx = state.recipes.findIndex(function (x) { return String(x.id) === String(id); });
        if (idx !== -1) {
          state.recipes[idx] = {
            id: state.recipes[idx].id,
            category: category,
            title: title,
            description: description,
            image: image,
            ingredients: ingredients,
            steps: steps
          };
          saveRecipes();
          location.hash = '#/receta/' + id;
        }
      }
      render();
    });
  }

  function renderPlan() {
    app.innerHTML = '<section class="space-y-6">' +
      '<div class="flex items-center justify-between flex-wrap gap-2">' +
      '<h1 class="text-2xl md:text-3xl font-bold">Plan de comidas</h1>' +
      '<div class="flex gap-2">' +
      '<a href="#/" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-700" title="Volver">' +
      '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></a>' +
      '<a href="#/plan/nueva" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-brand hover:text-white text-xl font-bold leading-none" title="Añadir semana">+</a>' +
      '<a href="#/plan/propuesta" class="px-3 py-2 rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-brand hover:text-white text-sm font-medium shrink-0" title="Generar propuesta">Propuesta</a>' +
      '</div></div>' +
      '<p class="text-slate-600 dark:text-slate-400" id="planLoading">Cargando plan…</p>' +
      '<div id="planContent" class="hidden space-y-8"></div>' +
      '<p id="planError" class="hidden text-red-600 dark:text-red-400"></p></section>';
    var planUrl = new URL('planning.json', location.href).href;
    if (location.protocol === 'file:') planUrl = 'planning.json';
    fetch(planUrl + (planUrl.indexOf('?') !== -1 ? '&' : '?') + 't=' + Date.now()).then(function (r) {
      if (!r.ok) throw new Error('planning.json no encontrado (' + r.status + ')');
      return r.json();
    }).then(function (data) {
      var loading = app.querySelector('#planLoading');
      var content = app.querySelector('#planContent');
      var errEl = app.querySelector('#planError');
      if (!data || !Array.isArray(data.weeks)) {
        if (loading) loading.classList.add('hidden');
        if (errEl) { errEl.textContent = 'El archivo no tiene el formato esperado (falta "weeks").'; errEl.classList.remove('hidden'); }
        return;
      }
      var weekdays = data.weekdays || ['L', 'M', 'X', 'J', 'V'];
      var labels = data.weekdayLabels || { L: 'Lunes', M: 'Martes', X: 'Miércoles', J: 'Jueves', V: 'Viernes' };
      var hiddenIds = loadHiddenPlanIds();
      var fromServer = (data.weeks || []).filter(function (w) { return hiddenIds.indexOf(w.id) === -1; });
      var serverIds = {};
      fromServer.forEach(function (w) { serverIds[w.id] = true; });
      var localOnly = loadPlanWeeks().filter(function (w) { return !serverIds[w.id]; });
      var allWeeks = localOnly.concat(fromServer).sort(function (a, b) { return b.id.localeCompare(a.id); });
      window.__planWeeksMap = {};
      var html = '';
      var shareSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>';
      var editSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
      var deleteSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
      allWeeks.forEach(function (w) {
        window.__planWeeksMap[w.id] = w;
        var comidas = w.comidas || [];
        var cenas = w.cenas || [];
        var dayRows = weekdays.map(function (d, i) {
          var dayName = labels[d] || d;
          var comida = (comidas[i] || '').replace(/</g, '&lt;');
          var cena = (cenas[i] || '').replace(/</g, '&lt;');
          return '<tr><td class="px-2 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 border-t border-slate-200 dark:border-slate-700">' + dayName + '</td><td class="px-2 py-2 text-sm border-t border-slate-200 dark:border-slate-700">' + comida + '</td><td class="px-2 py-2 text-sm border-t border-slate-200 dark:border-slate-700">' + cena + '</td></tr>';
        }).join('');
        var safeId = String(w.id).replace(/"/g, '&quot;');
        var btns = '<button type="button" data-plan-action="share" data-week-id="' + safeId + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-emerald-600 hover:text-white shrink-0" title="Compartir">' + shareSvg + '</button>' +
          '<button type="button" data-plan-action="edit" data-week-id="' + safeId + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-brand hover:text-white shrink-0" title="Editar">' + editSvg + '</button>' +
          '<button type="button" data-plan-action="delete" data-week-id="' + safeId + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-red-600 hover:text-white shrink-0" title="Eliminar">' + deleteSvg + '</button>';
        html += '<div class="rounded-xl border bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 overflow-hidden">' +
          '<div class="flex flex-wrap items-center justify-between gap-2 px-4 py-3 bg-slate-100 dark:bg-slate-800/80 border-b border-slate-200 dark:border-slate-700">' +
          '<h2 class="font-semibold text-lg min-w-0">' + formatWeekTitle(w.id, w.label) + '</h2>' +
          '<div class="flex gap-1.5 flex-shrink-0">' + btns + '</div></div>' +
          '<div class="overflow-x-auto"><table class="w-full text-left">' +
          '<thead><tr><th class="px-2 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-400 w-24"></th><th class="px-2 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase">Comida</th><th class="px-2 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase">Cena</th></tr></thead>' +
          '<tbody>' + dayRows + '</tbody></table></div></div>';
      });
      if (loading) loading.classList.add('hidden');
      if (content) { content.innerHTML = html; content.classList.remove('hidden'); }
      window.__planDayLabels = labels;
    }).catch(function (err) {
      var loading = app.querySelector('#planLoading');
      var content = app.querySelector('#planContent');
      var errEl = app.querySelector('#planError');
      if (loading) loading.classList.add('hidden');
      var fallbackEl = document.getElementById('planning-fallback');
      var data = null;
      if (fallbackEl && fallbackEl.textContent) {
        try { data = JSON.parse(fallbackEl.textContent); } catch (e) {}
      }
      if (data && Array.isArray(data.weeks)) {
        var weekdays = data.weekdays || ['L', 'M', 'X', 'J', 'V'];
        var labels = data.weekdayLabels || { L: 'Lunes', M: 'Martes', X: 'Miércoles', J: 'Jueves', V: 'Viernes' };
        var hiddenIds = loadHiddenPlanIds();
        var fromServer = (data.weeks || []).filter(function (w) { return hiddenIds.indexOf(w.id) === -1; });
        var serverIds = {};
        fromServer.forEach(function (w) { serverIds[w.id] = true; });
        var localOnly = loadPlanWeeks().filter(function (w) { return !serverIds[w.id]; });
        var allWeeks = localOnly.concat(fromServer).sort(function (a, b) { return b.id.localeCompare(a.id); });
        window.__planWeeksMap = {};
        var shareSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>';
        var editSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
        var deleteSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
        var html = '';
        allWeeks.forEach(function (w) {
          window.__planWeeksMap[w.id] = w;
          var comidas = w.comidas || [];
          var cenas = w.cenas || [];
          var dayRows = weekdays.map(function (d, i) {
            var dayName = labels[d] || d;
            var comida = (comidas[i] || '').replace(/</g, '&lt;');
            var cena = (cenas[i] || '').replace(/</g, '&lt;');
            return '<tr><td class="px-2 py-2 text-sm font-medium text-slate-600 dark:text-slate-300 border-t border-slate-200 dark:border-slate-700">' + dayName + '</td><td class="px-2 py-2 text-sm border-t border-slate-200 dark:border-slate-700">' + comida + '</td><td class="px-2 py-2 text-sm border-t border-slate-200 dark:border-slate-700">' + cena + '</td></tr>';
          }).join('');
          var safeId = String(w.id).replace(/"/g, '&quot;');
          var btns = '<button type="button" data-plan-action="share" data-week-id="' + safeId + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-emerald-600 hover:text-white shrink-0" title="Compartir">' + shareSvg + '</button>' +
            '<button type="button" data-plan-action="edit" data-week-id="' + safeId + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-brand hover:text-white shrink-0" title="Editar">' + editSvg + '</button>' +
            '<button type="button" data-plan-action="delete" data-week-id="' + safeId + '" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-red-600 hover:text-white shrink-0" title="Eliminar">' + deleteSvg + '</button>';
          html += '<div class="rounded-xl border bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 overflow-hidden">' +
            '<div class="flex flex-wrap items-center justify-between gap-2 px-4 py-3 bg-slate-100 dark:bg-slate-800/80 border-b border-slate-200 dark:border-slate-700">' +
            '<h2 class="font-semibold text-lg min-w-0">' + formatWeekTitle(w.id, w.label) + '</h2>' +
            '<div class="flex gap-1.5 flex-shrink-0">' + btns + '</div></div>' +
            '<div class="overflow-x-auto"><table class="w-full text-left">' +
            '<thead><tr><th class="px-2 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-400 w-24"></th><th class="px-2 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase">Comida</th><th class="px-2 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase">Cena</th></tr></thead>' +
            '<tbody>' + dayRows + '</tbody></table></div></div>';
        });
        if (content) { content.innerHTML = html; content.classList.remove('hidden'); }
        window.__planDayLabels = labels;
        return;
      }
      if (errEl) {
        var msg = err && err.message ? err.message : 'Error al cargar planning.json.';
        errEl.textContent = msg;
        errEl.classList.remove('hidden');
      }
    });
  }

  function generateMealProposals(mode) {
    var allWeeks = [];
    var customWeeks = loadPlanWeeks();
    allWeeks = allWeeks.concat(customWeeks);
    var hiddenIds = loadHiddenPlanIds();
    var fallbackEl = document.getElementById('planning-fallback');
    if (fallbackEl && fallbackEl.textContent) {
      try {
        var fallbackData = JSON.parse(fallbackEl.textContent);
        if (fallbackData && Array.isArray(fallbackData.weeks)) {
          var serverWeeks = fallbackData.weeks.filter(function (w) { return hiddenIds.indexOf(w.id) === -1; });
          allWeeks = allWeeks.concat(serverWeeks);
        }
      } catch (e) {}
    }
    allWeeks = allWeeks.filter(function (w) { return w && w.comidas && Array.isArray(w.comidas) && w.cenas && Array.isArray(w.cenas); });
    if (allWeeks.length === 0) return { comidas: ['', '', '', '', ''], cenas: ['', '', '', '', ''] };
    var proposalsComidas = ['', '', '', '', ''];
    var proposalsCenas = ['', '', '', '', ''];
    var weeksToAnalyze = allWeeks;
    if (mode === 'recent') {
      var sortedWeeks = allWeeks.slice().sort(function (a, b) {
        var aId = String(a.id || '');
        var bId = String(b.id || '');
        if (/^\d{4}-\d{2}-\d{2}$/.test(aId) && /^\d{4}-\d{2}-\d{2}$/.test(bId)) {
          return bId.localeCompare(aId);
        }
        return 0;
      });
      weeksToAnalyze = sortedWeeks.slice(0, 3);
    }
    var dayMeals = [{}, {}, {}, {}, {}];
    var dayDinners = [{}, {}, {}, {}, {}];
    weeksToAnalyze.forEach(function (w) {
      var comidas = w.comidas || [];
      var cenas = w.cenas || [];
      comidas.forEach(function (m, i) {
        if (i < 5 && m && m.trim()) {
          if (!dayMeals[i][m.trim()]) dayMeals[i][m.trim()] = 0;
          dayMeals[i][m.trim()]++;
        }
      });
      cenas.forEach(function (m, i) {
        if (i < 5 && m && m.trim()) {
          if (!dayDinners[i][m.trim()]) dayDinners[i][m.trim()] = 0;
          dayDinners[i][m.trim()]++;
        }
      });
    });
    dayMeals.forEach(function (meals, dayIdx) {
      var sorted = Object.keys(meals).map(function (m) { return { meal: m, count: meals[m] }; }).sort(function (a, b) { return b.count - a.count; });
      if (sorted.length > 0) proposalsComidas[dayIdx] = sorted[0].meal;
    });
    dayDinners.forEach(function (dinners, dayIdx) {
      var sorted = Object.keys(dinners).map(function (m) { return { meal: m, count: dinners[m] }; }).sort(function (a, b) { return b.count - a.count; });
      if (sorted.length > 0) proposalsCenas[dayIdx] = sorted[0].meal;
    });
    return { comidas: proposalsComidas, cenas: proposalsCenas };
  }

  function renderPlanNueva(proposals, showProposalButtons) {
    proposals = proposals || { comidas: ['', '', '', '', ''], cenas: ['', '', '', '', ''] };
    var days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
    var hoy = new Date();
    var lunes = new Date(hoy);
    lunes.setDate(hoy.getDate() - (hoy.getDay() || 7) + 1);
    var dateStr = lunes.getFullYear() + '-' + String(lunes.getMonth() + 1).padStart(2, '0') + '-' + String(lunes.getDate()).padStart(2, '0');
    var allMeals = getAllPlanMeals();
    var datalistId = 'plan-meals-datalist';
    var datalistHtml = allMeals.length > 0 ? '<datalist id="' + datalistId + '">' + allMeals.map(function (m) { return '<option value="' + m.replace(/"/g, '&quot;') + '">'; }).join('') + '</datalist>' : '';
    var proposalButtonsHtml = showProposalButtons ? '<div class="flex gap-2 mb-4"><button type="button" id="btnProposalFrequency" class="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-brand hover:text-white text-sm font-medium">Frecuencia</button><button type="button" id="btnProposalRecent" class="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-brand hover:text-white text-sm font-medium">Recientes</button></div>' : '';
      var rows = days.map(function (d, i) {
        var comidaVal = ((proposals.comidas && proposals.comidas[i]) || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
        var cenaVal = ((proposals.cenas && proposals.cenas[i]) || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
      return '<tr><td class="px-2 py-2 text-sm font-medium text-slate-600 dark:text-slate-300">' + d + '</td>' +
        '<td class="px-2 py-2"><input type="text" name="comida' + i + '" placeholder="Comida" value="' + comidaVal + '" list="' + datalistId + '" autocomplete="off" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm"/></td>' +
        '<td class="px-2 py-2"><input type="text" name="cena' + i + '" placeholder="Cena" value="' + cenaVal + '" list="' + datalistId + '" autocomplete="off" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm"/></td></tr>';
    }).join('');
    app.innerHTML = '<section class="max-w-2xl space-y-6">' +
      '<div class="flex items-center justify-between flex-wrap gap-2">' +
      '<h1 class="text-2xl font-bold">Nueva semana</h1>' +
      '<div class="flex gap-2">' +
      '<a href="#/plan" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-700" title="Volver">' +
      '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></a>' +
      '</div></div>' +
      '<form id="formPlanNueva" class="p-4 rounded-xl border bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 space-y-4">' +
      '<div><label class="block text-sm font-medium mb-1">Inicio de semana (lunes)</label>' +
      '<input type="date" name="fecha" value="' + dateStr + '" required class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800"/></div>' +
      proposalButtonsHtml +
      datalistHtml +
      '<div class="overflow-x-auto"><table class="w-full"><thead><tr><th class="px-2 py-2 text-left text-sm font-medium text-slate-500 dark:text-slate-400">Día</th><th class="px-2 py-2 text-left text-sm font-medium text-slate-500 dark:text-slate-400">Comida</th><th class="px-2 py-2 text-left text-sm font-medium text-slate-500 dark:text-slate-400">Cena</th></tr></thead><tbody>' + rows + '</tbody></table></div>' +
      '<div class="flex gap-2"><button type="submit" class="px-4 py-2 rounded-lg bg-brand text-white hover:bg-brand-dark">Añadir semana</button><a href="#/plan" class="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700">Cancelar</a></div>' +
      '</form></section>';
    if (showProposalButtons) {
      var btnFreq = app.querySelector('#btnProposalFrequency');
      var btnRecent = app.querySelector('#btnProposalRecent');
      if (btnFreq) {
        btnFreq.addEventListener('click', function () {
          var proposals = generateMealProposals('frequency');
          for (var i = 0; i < 5; i++) {
            var comidaInput = app.querySelector('input[name="comida' + i + '"]');
            var cenaInput = app.querySelector('input[name="cena' + i + '"]');
            if (comidaInput) comidaInput.value = proposals.comidas[i] || '';
            if (cenaInput) cenaInput.value = proposals.cenas[i] || '';
          }
        });
      }
      if (btnRecent) {
        btnRecent.addEventListener('click', function () {
          var proposals = generateMealProposals('recent');
          for (var i = 0; i < 5; i++) {
            var comidaInput = app.querySelector('input[name="comida' + i + '"]');
            var cenaInput = app.querySelector('input[name="cena' + i + '"]');
            if (comidaInput) comidaInput.value = proposals.comidas[i] || '';
            if (cenaInput) cenaInput.value = proposals.cenas[i] || '';
          }
        });
      }
    }
    var formEl = app.querySelector('#formPlanNueva');
    if (formEl) {
      formEl.addEventListener('submit', function (e) {
      e.preventDefault();
      var form = e.target;
      var fecha = (form.fecha.value || '').trim();
      if (!fecha) return;
      var comidas = [];
      var cenas = [];
      for (var i = 0; i < 5; i++) {
        comidas.push((form['comida' + i].value || '').trim());
        cenas.push((form['cena' + i].value || '').trim());
      }
      var label = planWeekLabel(fecha);
      var weeks = loadPlanWeeks();
      if (weeks.some(function (w) { return w.id === fecha; })) {
        if (!confirm('Ya existe una semana con esa fecha. ¿Sustituirla?')) return;
        weeks = weeks.filter(function (w) { return w.id !== fecha; });
      }
      weeks.push({ id: fecha, label: label, comidas: comidas, cenas: cenas });
      savePlanWeeks(weeks);
      location.hash = '#/plan';
      render();
      });
    }
  }

  function renderPlanPropuesta() {
    renderPlanNueva({ comidas: ['', '', '', '', ''], cenas: ['', '', '', '', ''] }, true);
  }

  function renderPlanEditar(id) {
    var weeks = loadPlanWeeks();
    var w = weeks.find(function (x) { return x.id === id; });
    if (!w) {
      try {
        var raw = sessionStorage.getItem('planEditWeek');
        if (raw) {
          var parsed = JSON.parse(raw);
          if (parsed && parsed.w) {
            if (!parsed.id || parsed.id === id) {
              w = parsed.w;
              sessionStorage.removeItem('planEditWeek');
            }
          }
        }
      } catch (e) {}
    }
    if (!w && window.__planWeeksMap && id) {
      w = window.__planWeeksMap[id];
    }
    if (!w) {
      location.hash = '#/plan';
      return render();
    }
    var days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
    var dateStr = /^\d{4}-\d{2}-\d{2}$/.test(String(w.id)) ? w.id : (function () {
      var d = new Date();
      d.setDate(d.getDate() - (d.getDay() || 7) + 1);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    })();
    var allMeals = getAllPlanMeals();
    var datalistId = 'plan-meals-datalist';
    var datalistHtml = allMeals.length > 0 ? '<datalist id="' + datalistId + '">' + allMeals.map(function (m) { return '<option value="' + m.replace(/"/g, '&quot;') + '">'; }).join('') + '</datalist>' : '';
    var rows = days.map(function (d, i) {
      var comidaVal = (w.comidas && w.comidas[i] != null) ? w.comidas[i].replace(/"/g, '&quot;').replace(/</g, '&lt;') : '';
      var cenaVal = (w.cenas && w.cenas[i] != null) ? w.cenas[i].replace(/"/g, '&quot;').replace(/</g, '&lt;') : '';
      return '<tr><td class="px-2 py-2 text-sm font-medium text-slate-600 dark:text-slate-300">' + d + '</td>' +
        '<td class="px-2 py-2"><input type="text" name="comida' + i + '" placeholder="Comida" value="' + comidaVal + '" list="' + datalistId + '" autocomplete="off" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm"/></td>' +
        '<td class="px-2 py-2"><input type="text" name="cena' + i + '" placeholder="Cena" value="' + cenaVal + '" list="' + datalistId + '" autocomplete="off" class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-sm"/></td></tr>';
    }).join('');
    app.innerHTML = '<section class="max-w-2xl space-y-6">' +
      '<div class="flex items-center justify-between flex-wrap gap-2">' +
      '<h1 class="text-2xl font-bold">Editar semana</h1>' +
      '<div class="flex gap-2">' +
      '<a href="#/plan" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-700" title="Volver">' +
      '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></a>' +
      '</div></div>' +
      '<form id="formPlanEditar" class="p-4 rounded-xl border bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 space-y-4">' +
      '<div><label class="block text-sm font-medium mb-1">Inicio de semana (lunes)</label>' +
      '<input type="date" name="fecha" value="' + dateStr + '" required class="w-full px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800"/></div>' +
      datalistHtml +
      '<div class="overflow-x-auto"><table class="w-full"><thead><tr><th class="px-2 py-2 text-left text-sm font-medium text-slate-500 dark:text-slate-400">Día</th><th class="px-2 py-2 text-left text-sm font-medium text-slate-500 dark:text-slate-400">Comida</th><th class="px-2 py-2 text-left text-sm font-medium text-slate-500 dark:text-slate-400">Cena</th></tr></thead><tbody>' + rows + '</tbody></table></div>' +
      '<div class="flex gap-2"><button type="submit" class="px-4 py-2 rounded-lg bg-brand text-white hover:bg-brand-dark">Guardar</button><a href="#/plan" class="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700">Cancelar</a></div>' +
      '</form></section>';
    app.querySelector('#formPlanEditar').addEventListener('submit', function (e) {
      e.preventDefault();
      var form = e.target;
      var fecha = (form.fecha.value || '').trim();
      if (!fecha) return;
      var comidas = [];
      var cenas = [];
      for (var i = 0; i < 5; i++) {
        comidas.push((form['comida' + i].value || '').trim());
        cenas.push((form['cena' + i].value || '').trim());
      }
      var label = planWeekLabel(fecha);
      var updated = weeks.filter(function (x) { return x.id !== id; });
      if (fecha !== id && updated.some(function (x) { return x.id === fecha; })) {
        if (!confirm('Ya existe una semana con esa fecha. ¿Sustituirla?')) return;
        updated = updated.filter(function (x) { return x.id !== fecha; });
      }
      updated.push({ id: fecha, label: label, comidas: comidas, cenas: cenas });
      savePlanWeeks(updated);
      location.hash = '#/plan';
      render();
    });
  }

  function renderImportar() {
    app.innerHTML = '<section class="max-w-2xl space-y-6">' +
      '<h1 class="text-2xl font-bold">Importar recetas desde JSON</h1>' +
      '<p class="text-slate-600 dark:text-slate-400">Selecciona un archivo <code class="bg-slate-200 dark:bg-slate-700 px-1 rounded">recipes.json</code> (array de recetas). Se fusionarán con las actuales; si una receta tiene el mismo <code class="bg-slate-200 dark:bg-slate-700 px-1 rounded">id</code>, se actualizará.</p>' +
      '<div class="flex flex-wrap gap-2">' +
      '<input type="file" id="fileJson" accept=".json,application/json" class="block w-full text-sm"/>' +
      '<a href="#/" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-700" title="Volver al inicio">' +
      '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></a>' +
      '</div>' +
      '<div id="importResult" class="hidden p-3 rounded-lg bg-slate-100 dark:bg-slate-800 text-sm"></div></section>';

    app.querySelector('#fileJson').addEventListener('change', function (e) {
      var f = e.target.files[0];
      var res = app.querySelector('#importResult');
      if (!f) return;
      var reader = new FileReader();
      reader.onload = function () {
        try {
          var result = applyImportedRecipes(reader.result);
          saveRecipes();
          res.textContent = 'Importado: ' + result.added + ' nuevas, ' + result.updated + ' actualizadas. Total: ' + state.recipes.length + ' recetas.';
          res.classList.remove('hidden');
        } catch (err) {
          res.textContent = 'Error: ' + err.message;
          res.classList.remove('hidden');
        }
      };
      reader.readAsText(f);
    });
  }

  function render404() {
    app.innerHTML = '<div class="space-y-4"><h1 class="text-2xl font-bold">Página no encontrada</h1><a href="#/" class="inline-flex w-9 h-9 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-700" title="Ir al inicio">' +
      '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg></a></div>';
  }

  window.addEventListener('hashchange', render);
  window.addEventListener('load', function () {
    render();
    if (state.recipes.length === 0) {
      fetch('recipes.json').then(function (r) { return r.ok ? r.json() : []; }).then(function (data) {
        var arr = Array.isArray(data) ? data : (data.recipes || []);
        if (arr.length > 0) {
          state.recipes = arr;
          saveRecipes();
          render();
        }
      }).catch(function () {});
    }
  });

  function closeOperacionesMenu() {
    var menu = document.getElementById('operacionesMenu');
    var btn = document.getElementById('btnOperaciones');
    if (menu) menu.classList.add('hidden');
    if (btn) btn.setAttribute('aria-expanded', 'false');
  }

  document.getElementById('btnOperaciones').addEventListener('click', function (e) {
    e.stopPropagation();
    var menu = document.getElementById('operacionesMenu');
    var btn = document.getElementById('btnOperaciones');
    if (!menu || !btn) return;
    var isOpen = !menu.classList.contains('hidden');
    if (isOpen) { menu.classList.add('hidden'); btn.setAttribute('aria-expanded', 'false'); }
    else { menu.classList.remove('hidden'); btn.setAttribute('aria-expanded', 'true'); }
  });

  document.addEventListener('click', function (e) {
    var menu = document.getElementById('operacionesMenu');
    var wrap = document.getElementById('operacionesWrap');
    if (menu && menu.contains(e.target)) closeOperacionesMenu();
    if (wrap && !wrap.contains(e.target)) closeOperacionesMenu();
    var id = e.target && e.target.id;
    if (id === 'btnExportar') { e.preventDefault(); closeOperacionesMenu(); exportRecipes(); }
    if (id === 'btnImportar') {
      e.preventDefault();
      closeOperacionesMenu();
      var input = document.getElementById('headerImportFile');
      if (input) input.click();
    }
    if (id === 'btnResetear') { e.preventDefault(); closeOperacionesMenu(); resetRecipes(); }
    if (id === 'btnActualizar') { e.preventDefault(); closeOperacionesMenu(); forceUpdate(); }
    var shareBtn = e.target && (e.target.closest && e.target.closest('[data-share-id]'));
    if (shareBtn) {
      e.preventDefault();
      shareRecipe(shareBtn.getAttribute('data-share-id'));
    }
    var planBtn = e.target && (e.target.closest && e.target.closest('[data-plan-action]'));
    if (planBtn) {
      e.preventDefault();
      var weekId = planBtn.getAttribute('data-week-id');
      var action = planBtn.getAttribute('data-plan-action');
      var w = window.__planWeeksMap && weekId && window.__planWeeksMap[weekId];
      var labels = window.__planDayLabels || { L: 'Lunes', M: 'Martes', X: 'Miércoles', J: 'Jueves', V: 'Viernes' };
      if (w && action === 'share') {
        generateWeekImage(w, labels).then(function (blob) {
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          var weekTitle = (w.label || w.id || 'semana').replace(/[^a-z0-9]/gi, '_').toLowerCase();
          a.download = weekTitle + '.png';
          a.click();
          setTimeout(function () {
            URL.revokeObjectURL(url);
            if (navigator.clipboard && navigator.clipboard.write) {
              blob.arrayBuffer().then(function (buffer) {
                return navigator.clipboard.write([
                  new ClipboardItem({ 'image/png': new Blob([buffer], { type: 'image/png' }) })
                ]);
              }).then(function () {
                alert('Imagen descargada y copiada al portapapeles.');
              }).catch(function () {
                alert('Imagen descargada. No se pudo copiar al portapapeles.');
              });
            } else {
              alert('Imagen descargada.');
            }
          }, 100);
        }).catch(function (err) {
          console.error('Error generando imagen:', err);
          var text = formatWeekForShare(w, labels);
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function () { alert('No se pudo generar la imagen. Texto copiado al portapapeles.'); }).catch(function () { fallbackCopy(text); });
          } else { fallbackCopy(text); }
        });
      }
      if (action === 'edit') {
        if (!w && window.__planWeeksMap && weekId) {
          w = window.__planWeeksMap[weekId];
        }
        if (w) {
          try { sessionStorage.setItem('planEditWeek', JSON.stringify({ id: weekId, w: w })); } catch (e) {}
          location.hash = '#/plan/editar/' + encodeURIComponent(weekId);
          render();
        } else {
          alert('No se pudo cargar la semana. Recarga la página e inténtalo de nuevo.');
        }
      }
      if (w && action === 'delete') {
        if (!confirm('¿Eliminar esta semana del plan?')) return;
        if (/^\d{4}-\d{2}-\d{2}$/.test(String(weekId))) {
          var weeks = loadPlanWeeks().filter(function (x) { return x.id !== weekId; });
          savePlanWeeks(weeks);
        } else {
          var hidden = loadHiddenPlanIds();
          if (hidden.indexOf(weekId) === -1) hidden.push(weekId);
          saveHiddenPlanIds(hidden);
        }
        location.hash = '#/plan';
        render();
      }
    }
    var deleteBtn = e.target && (e.target.closest && e.target.closest('[data-delete-id]'));
    if (deleteBtn) {
      e.preventDefault();
      var recId = deleteBtn.getAttribute('data-delete-id');
      var rec = state.recipes.find(function (x) { return String(x.id) === String(recId); });
      if (!rec) return;
      if (!confirm("¿Eliminar la receta \"" + (rec.title || '').replace(/"/g, '\\"') + "\"?")) return;
      state.recipes = state.recipes.filter(function (x) { return String(x.id) !== String(recId); });
      saveRecipes();
      render();
    }
  });

  var searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('input', function () {
      state.searchQuery = searchInput.value.trim();
      render();
    });
    searchInput.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') { searchInput.value = ''; state.searchQuery = ''; searchInput.blur(); render(); }
    });
  }

  document.getElementById('btnDarkMode').addEventListener('click', function () {
    var root = document.documentElement;
    var isDark = root.classList.contains('dark');
    if (isDark) {
      root.classList.remove('dark');
      localStorage.setItem(THEME_KEY, 'light');
    } else {
      root.classList.add('dark');
      localStorage.setItem(THEME_KEY, 'dark');
    }
  });

  var headerImportFile = document.getElementById('headerImportFile');
  if (headerImportFile) {
    headerImportFile.addEventListener('change', function (e) {
      var f = e.target.files[0];
      if (!f) return;
      var reader = new FileReader();
      reader.onload = function () {
        try {
          applyImportedRecipes(reader.result);
          saveRecipes();
          location.hash = '#/';
          render();
        } catch (err) {
          alert('Error al importar: ' + err.message);
        }
        headerImportFile.value = '';
      };
      reader.readAsText(f);
    });
  }

  var versionEl = document.getElementById('appVersion');
  if (versionEl) versionEl.textContent = 'v' + APP_VERSION;
})();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('service-worker.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
